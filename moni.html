<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资金管理模拟器：全指标专业版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #E2E8F0;
            border-radius: 4px;
        }
        .card { transition: transform 0.2s; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        /* Custom styles */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <h1 class="text-xl font-bold text-slate-800">资金管理实验室</h1>
                </div>
                <div class="text-sm text-slate-500 hidden sm:block">Advanced Money Management Simulator</div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
            
            <!-- Controls Panel -->
            <div class="lg:col-span-4 bg-white rounded-xl shadow-sm border border-slate-200 p-6 card h-fit">
                <h2 class="text-lg font-semibold mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                    基础参数
                </h2>

                <!-- RR Slider -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-bold text-slate-700">盈亏比 (R:R)</label>
                        <span class="text-indigo-600 font-bold" id="rrDisplay">1 : 2.0</span>
                    </div>
                    <!-- Modified min and step to allow 0.1 and 0.125 -->
                    <input type="range" min="0.1" max="5" step="0.025" value="2.0" class="w-full h-2 rounded-lg appearance-none cursor-pointer" id="rrSlider">
                </div>

                <!-- Win Rate Slider -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-600">胜率 (Win Rate)</label>
                        <span class="text-slate-700 font-bold" id="winRateDisplay">40%</span>
                    </div>
                    <input type="range" min="1" max="99" value="40" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" id="winRateSlider">
                </div>

                <div class="border-t border-slate-100 my-6"></div>

                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-indigo-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    资金管理策略
                </h2>

                <!-- Money Management Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-600 mb-2">策略模型</label>
                    <select id="mmStrategy" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                        <option value="fixed_pct">固定比例 (Fixed %) - 推荐</option>
                        <option value="fixed_amt">固定金额 (Fixed $)</option>
                        <option value="martingale">马丁格尔 (亏损加倍)</option>
                        <option value="anti_martingale">反马丁 (连胜加倍)</option>
                    </select>
                </div>

                <!-- Base Risk -->
                <div class="mb-4">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium text-slate-600">基础风险 (Base Risk)</label>
                        <span class="text-slate-700 font-bold" id="riskDisplay">1%</span>
                    </div>
                    <input type="range" min="0.1" max="5" step="0.1" value="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" id="riskSlider">
                </div>

                <!-- Multiplier Controls (Hidden for Fixed strategies) -->
                <div id="multiplierControl" class="hidden mb-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100 space-y-5">
                    
                    <!-- Multiplier Rate -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-bold text-indigo-800">加仓倍率 (Multiplier)</label>
                            <span class="text-indigo-600 font-bold" id="multDisplay">2.0x</span>
                        </div>
                        <input type="range" min="1.1" max="3.0" step="0.1" value="2.0" class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer" id="multSlider">
                        <p class="text-xs text-indigo-600 mt-1" id="multDesc">亏损后下注金额 × 2.0</p>
                    </div>

                    <!-- Max Cap Limit -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-bold text-indigo-800">最大倍数限制 (Max Cap)</label>
                            <span class="text-indigo-600 font-bold" id="maxCapDisplay">8x</span>
                        </div>
                        <input type="range" min="1" max="64" step="1" value="8" class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer" id="maxCapSlider">
                        <p class="text-xs text-indigo-600 mt-1">达到基础风险的 <span id="maxCapText">8</span> 倍后停止加倍</p>
                    </div>

                </div>

            </div>

            <!-- Analysis Panel -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                
                <!-- Simulation Chart -->
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 flex-grow flex flex-col min-h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">资金曲线模拟 (100笔)</h3>
                            <p class="text-xs text-slate-500" id="simSubTitle">基础参数：胜率 40% | 盈亏比 1:2 | 初始资金 $10,000</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="runSimulation()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded transition shadow-sm">
                                重新模拟 (随机)
                            </button>
                        </div>
                    </div>
                    
                    <div class="chart-container flex-grow relative">
                        <canvas id="simulationChart"></canvas>
                        <!-- Overlay for "BUSTED" -->
                        <div id="bustOverlay" class="hidden absolute inset-0 flex items-center justify-center bg-white/80 z-10">
                            <div class="text-center">
                                <div class="text-6xl font-black text-rose-600 mb-2">爆仓!</div>
                                <div class="text-xl text-rose-800">账户归零 (BUSTED)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-4 border-t border-slate-100 pt-4">
                        <!-- Row 1 -->
                        <div class="text-center p-2 bg-slate-50 rounded-lg">
                            <div class="text-xs text-slate-400">最终余额</div>
                            <div class="font-bold text-slate-800" id="finalBalance">$--</div>
                        </div>
                        <div class="text-center p-2 bg-slate-50 rounded-lg">
                            <div class="text-xs text-slate-400">最大回撤 (DD%)</div>
                            <div class="font-bold text-rose-500" id="maxDrawdown">--%</div>
                        </div>
                        <div class="text-center p-2 bg-slate-50 rounded-lg">
                            <div class="text-xs text-slate-400">最大连亏</div>
                            <div class="font-bold text-slate-600" id="maxConsLoss">0</div>
                        </div>
                         <div class="text-center p-2 bg-slate-50 rounded-lg">
                            <div class="text-xs text-slate-400">最大单笔下注</div>
                            <div class="font-bold text-indigo-600" id="maxBetSize">$0</div>
                        </div>

                        <!-- Row 2: Advanced Metrics -->
                        <div class="text-center p-2 bg-indigo-50/50 rounded-lg border border-indigo-100">
                            <div class="text-xs text-slate-500">盈利因子 (PF)</div>
                            <div class="font-bold text-emerald-600" id="pfDisplay">--</div>
                        </div>
                        <div class="text-center p-2 bg-indigo-50/50 rounded-lg border border-indigo-100">
                            <div class="text-xs text-slate-500">夏普比率 (Sharpe)</div>
                            <div class="font-bold text-blue-600" id="sharpeDisplay">--</div>
                        </div>
                        <div class="text-center p-2 bg-indigo-50/50 rounded-lg border border-indigo-100">
                            <div class="text-xs text-slate-500">恢复系数 (Recover)</div>
                            <div class="font-bold text-purple-600" id="recoverDisplay">--</div>
                        </div>
                        <div class="text-center p-2 bg-indigo-50/50 rounded-lg border border-indigo-100">
                            <div class="text-xs text-slate-500">净利润 (Net)</div>
                            <div class="font-bold text-slate-700" id="netProfitDisplay">--</div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Explanation -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                         <h4 class="font-bold text-slate-800 mb-2 border-b pb-2">当前策略特性</h4>
                         <div id="strategyExplanation" class="text-sm text-slate-600 leading-relaxed">
                             --
                         </div>
                    </div>
                    
                    <!-- Edge Analysis (Mini) -->
                    <div class="bg-slate-900 rounded-xl shadow-sm p-5 text-white">
                        <h4 class="font-bold text-slate-300 mb-2 border-b border-slate-700 pb-2">基础数学期望</h4>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-slate-400">期望值 (每1R风险)</span>
                            <span class="text-2xl font-bold" id="expectancyVal">--</span>
                        </div>
                        <div class="text-xs text-slate-500">
                            提示：注意观察夏普比率。马丁格尔策略通常会有一个极差的夏普比率（收益曲线不平滑，回撤剧烈），即使PF看起来不错。
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script>
        // --- State Management ---
        const state = {
            winRate: 0.40, 
            rrRatio: 2.0,  
            baseRiskPct: 0.01, // 1%
            startBalance: 10000,
            mmStrategy: 'fixed_pct', 
            multiplier: 2.0,
            maxCap: 8
        };

        // --- DOM Elements ---
        const els = {
            winRateSlider: document.getElementById('winRateSlider'),
            winRateDisplay: document.getElementById('winRateDisplay'),
            rrSlider: document.getElementById('rrSlider'),
            rrDisplay: document.getElementById('rrDisplay'),
            riskSlider: document.getElementById('riskSlider'),
            riskDisplay: document.getElementById('riskDisplay'),
            mmStrategy: document.getElementById('mmStrategy'),
            multSlider: document.getElementById('multSlider'),
            multDisplay: document.getElementById('multDisplay'),
            multDesc: document.getElementById('multDesc'),
            maxCapSlider: document.getElementById('maxCapSlider'),
            maxCapDisplay: document.getElementById('maxCapDisplay'),
            maxCapText: document.getElementById('maxCapText'),
            multiplierControl: document.getElementById('multiplierControl'),
            // Outputs
            finalBalance: document.getElementById('finalBalance'),
            maxDrawdown: document.getElementById('maxDrawdown'),
            maxConsLoss: document.getElementById('maxConsLoss'),
            maxBetSize: document.getElementById('maxBetSize'),
            // Advanced Outputs
            pfDisplay: document.getElementById('pfDisplay'),
            sharpeDisplay: document.getElementById('sharpeDisplay'),
            recoverDisplay: document.getElementById('recoverDisplay'),
            netProfitDisplay: document.getElementById('netProfitDisplay'),
            
            bustOverlay: document.getElementById('bustOverlay'),
            expectancyVal: document.getElementById('expectancyVal'),
            strategyExplanation: document.getElementById('strategyExplanation'),
            simSubTitle: document.getElementById('simSubTitle')
        };

        let simulationChartInstance = null;

        // --- Core Simulation Logic ---
        function runSimulation() {
            const tradeCount = 100;
            const dataPoints = [state.startBalance];
            const labels = [0];
            const tradeResults = []; // To store P/L of each trade
            
            let currentBalance = state.startBalance;
            let peakBalance = state.startBalance;
            let maxDDPercentage = 0;
            let maxDDAmount = 0; // Absolute amount for Recovery Factor
            let maxBet = 0;
            let consecutiveLosses = 0;
            let maxConsecutiveLosses = 0;
            let isBusted = false;
            let grossProfit = 0;
            let grossLoss = 0;

            // Strategy variables
            let currentRiskAmount = 0;
            let lastTradeResult = null; // 'win' or 'loss'
            const baseRiskAmount = state.startBalance * state.baseRiskPct;

            // Reset Overlay
            els.bustOverlay.classList.add('hidden');

            for (let i = 1; i <= tradeCount; i++) {
                if (currentBalance <= 1) {
                    isBusted = true;
                    currentBalance = 0;
                    dataPoints.push(0);
                    labels.push(i);
                    continue; 
                }

                // 1. Determine Bet Size
                switch (state.mmStrategy) {
                    case 'fixed_pct':
                        currentRiskAmount = currentBalance * state.baseRiskPct;
                        break;
                    case 'fixed_amt':
                        currentRiskAmount = baseRiskAmount;
                        break;
                    case 'martingale':
                        if (lastTradeResult === 'loss') {
                            let proposedRisk = currentRiskAmount * state.multiplier;
                            let maxRisk = baseRiskAmount * state.maxCap;
                            currentRiskAmount = Math.min(proposedRisk, maxRisk);
                        } else {
                            currentRiskAmount = baseRiskAmount;
                        }
                        break;
                    case 'anti_martingale':
                        if (lastTradeResult === 'win') {
                            let proposedRisk = currentRiskAmount * state.multiplier;
                            let maxRisk = baseRiskAmount * state.maxCap;
                            currentRiskAmount = Math.min(proposedRisk, maxRisk);
                        } else {
                            currentRiskAmount = baseRiskAmount;
                        }
                        break;
                }

                if (currentRiskAmount > currentBalance) currentRiskAmount = currentBalance;
                if (currentRiskAmount > maxBet) maxBet = currentRiskAmount;

                // 2. Trade Outcome
                const isWin = Math.random() < state.winRate;
                let tradePL = 0;

                if (isWin) {
                    tradePL = currentRiskAmount * state.rrRatio;
                    currentBalance += tradePL;
                    
                    grossProfit += tradePL;
                    lastTradeResult = 'win';
                    consecutiveLosses = 0;
                } else {
                    tradePL = -currentRiskAmount;
                    currentBalance -= currentRiskAmount;
                    
                    grossLoss += currentRiskAmount;
                    lastTradeResult = 'loss';
                    consecutiveLosses++;
                    if (consecutiveLosses > maxConsecutiveLosses) maxConsecutiveLosses = consecutiveLosses;
                }
                
                tradeResults.push(tradePL);

                // 3. Drawdown calc (Percentage & Amount)
                if (currentBalance > peakBalance) peakBalance = currentBalance;
                
                const ddAmount = peakBalance - currentBalance;
                if (ddAmount > maxDDAmount) maxDDAmount = ddAmount;

                const ddPct = ddAmount / peakBalance;
                if (ddPct > maxDDPercentage) maxDDPercentage = ddPct;

                dataPoints.push(currentBalance);
                labels.push(i);
            }

            // --- Calc Advanced Metrics ---
            // Profit Factor
            let pf = grossLoss === 0 ? (grossProfit > 0 ? 999.0 : 0.0) : (grossProfit / grossLoss);

            // Sharpe Ratio (Per Trade)
            // Sharpe = Mean Return / StdDev Return
            // We use P/L amounts for simplicity in this visualizer
            let meanPL = tradeResults.length > 0 ? tradeResults.reduce((sum, val) => sum + val, 0) / tradeResults.length : 0;
            let variancePL = tradeResults.length > 0 ? tradeResults.reduce((sum, val) => sum + Math.pow(val - meanPL, 2), 0) / tradeResults.length : 0;
            let stdDevPL = Math.sqrt(variancePL);
            let sharpe = stdDevPL === 0 ? 0 : (meanPL / stdDevPL);

            // Recovery Factor = Net Profit / Max Drawdown Amount
            let netProfit = currentBalance - state.startBalance;
            let recoveryFactor = maxDDAmount <= 1 ? (netProfit > 0 ? 99.0 : 0.0) : (netProfit / maxDDAmount);

            // --- Update UI ---
            renderChart(labels, dataPoints, isBusted);

            // Basic Stats
            els.finalBalance.textContent = '$' + Math.floor(currentBalance).toLocaleString();
            els.finalBalance.className = currentBalance > state.startBalance ? "font-bold text-emerald-600" : "font-bold text-rose-600";
            els.maxDrawdown.textContent = (maxDDPercentage * 100).toFixed(2) + '%';
            els.maxConsLoss.textContent = maxConsecutiveLosses;
            els.maxBetSize.textContent = '$' + Math.floor(maxBet).toLocaleString();

            // Advanced Stats
            els.pfDisplay.textContent = pf.toFixed(2);
            els.pfDisplay.className = pf > 1.5 ? "font-bold text-emerald-600" : (pf > 1 ? "font-bold text-blue-600" : "font-bold text-rose-600");
            
            els.sharpeDisplay.textContent = sharpe.toFixed(2);
            els.sharpeDisplay.className = sharpe > 0.1 ? "font-bold text-blue-600" : "font-bold text-slate-500";
            
            els.recoverDisplay.textContent = recoveryFactor.toFixed(2);
            els.recoverDisplay.className = recoveryFactor > 2 ? "font-bold text-purple-600" : (recoveryFactor > 0 ? "font-bold text-slate-600" : "font-bold text-rose-600");

            els.netProfitDisplay.textContent = (netProfit > 0 ? "+" : "") + '$' + Math.floor(netProfit).toLocaleString();
            els.netProfitDisplay.className = netProfit > 0 ? "font-bold text-emerald-700" : "font-bold text-rose-700";

            if(isBusted) els.bustOverlay.classList.remove('hidden');

            updateExpectancy();
        }

        function renderChart(labels, dataPoints, isBusted) {
            const ctx = document.getElementById('simulationChart').getContext('2d');
            
            if (simulationChartInstance) {
                simulationChartInstance.destroy();
            }

            const endBalance = dataPoints[dataPoints.length - 1];
            const isProfitable = endBalance > state.startBalance;
            const lineColor = isBusted ? '#e11d48' : (isProfitable ? '#059669' : '#e11d48');
            const fillColor = isBusted ? 'rgba(225, 29, 72, 0.1)' : (isProfitable ? 'rgba(5, 150, 105, 0.1)' : 'rgba(225, 29, 72, 0.1)');

            simulationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '账户净值',
                        data: dataPoints,
                        borderColor: lineColor,
                        backgroundColor: fillColor,
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        x: { display: true, title: {display:true, text:'交易次数'} },
                        y: { beginAtZero: true, title: {display:true, text:'资金'} }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateExpectancy() {
            const winRate = state.winRate;
            const reward = state.rrRatio;
            const risk = 1;
            const expectancy = (winRate * reward) - ((1 - winRate) * risk);
            
            const eVal = expectancy.toFixed(2) + ' R';
            const color = expectancy > 0 ? "text-emerald-400" : "text-rose-400";
            els.expectancyVal.innerHTML = `<span class="${color}">${eVal}</span>`;
        }

        function updateStrategyInfo() {
            const strat = state.mmStrategy;
            let text = "";
            let showMult = false;

            if (strat === 'fixed_pct') {
                text = "<strong>复利增长模式：</strong> 推荐。资金管理圣杯。利用复利效应，在连胜时加速，连败时自动减小头寸保护本金。通常产生较高的夏普比率。";
            } else if (strat === 'fixed_amt') {
                text = "<strong>单利模式：</strong> 线性增长。风险固定。随着账户增长，实际上是在降低风险比例（De-leveraging），这会导致Recovery Factor随着时间推移变差（因为利润相对于账户规模变小）。";
            } else if (strat === 'martingale') {
                showMult = true;
                text = "<strong>马丁格尔：</strong> 输了加倍。你会看到PF可能很高（如果是正期望），但夏普比率通常很低，因为波动率（风险）极高。注意观察最大回撤，通常一次失败就会造成巨大回撤。";
                els.multDesc.textContent = `亏损后下注金额 × ${state.multiplier.toFixed(1)}`;
            } else if (strat === 'anti_martingale') {
                showMult = true;
                text = "<strong>反马丁：</strong> 赢了加倍。这是一种试图“用市场的钱玩”的策略。在趋势或连胜时，Recovery Factor会非常惊人，但在震荡市中会被反复止损磨损本金。";
                els.multDesc.textContent = `盈利后下注金额 × ${state.multiplier.toFixed(1)}`;
            }

            els.strategyExplanation.innerHTML = text;
            
            if (showMult) {
                els.multiplierControl.classList.remove('hidden');
            } else {
                els.multiplierControl.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        function handleInput() {
            // Update State
            state.winRate = parseInt(els.winRateSlider.value) / 100;
            state.rrRatio = parseFloat(els.rrSlider.value);
            state.baseRiskPct = parseFloat(els.riskSlider.value) / 100;
            state.mmStrategy = els.mmStrategy.value;
            state.multiplier = parseFloat(els.multSlider.value);
            state.maxCap = parseInt(els.maxCapSlider.value);

            // Update UI Labels
            els.winRateDisplay.textContent = Math.round(state.winRate * 100) + '%';
            
            // Format RR string
            let rrVal = state.rrRatio;
            let rrStr = (rrVal % 1 === 0) ? rrVal.toFixed(1) : rrVal.toString();
            els.rrDisplay.textContent = '1 : ' + rrStr;
            
            els.riskDisplay.textContent = (state.baseRiskPct * 100).toFixed(1) + '%';
            els.multDisplay.textContent = state.multiplier.toFixed(1) + 'x';
            els.maxCapDisplay.textContent = state.maxCap + 'x';
            els.maxCapText.textContent = state.maxCap;
            
            els.simSubTitle.textContent = `基础参数：胜率 ${(state.winRate*100).toFixed(0)}% | 盈亏比 1:${rrStr} | 初始资金 $10,000`;

            updateStrategyInfo();
            runSimulation();
        }

        [els.winRateSlider, els.rrSlider, els.riskSlider, els.mmStrategy, els.multSlider, els.maxCapSlider].forEach(el => {
            el.addEventListener('input', handleInput);
        });

        // --- Init ---
        window.addEventListener('DOMContentLoaded', () => {
            handleInput(); // Initial setup
        });

    </script>
</body>
</html>
